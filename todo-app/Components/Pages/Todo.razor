@page "/todo"
@using Models;
@using Microsoft.EntityFrameworkCore;
@inject AppDbContext DbContext

<h3>To-Do Application</h3>

<input @bind="newTaskDescription" placeholder="Enter a new task" />
<button @onclick="AddTask">Add Task</button>

<ul>
    @foreach (var task in tasks)
    {
        <li>
            <input type="checkbox" @bind="task.IsCompleted" @bind:after="() => UpdateTask(task)" />
            @task.Description
            <button @onclick="() => RemoveTask(task)">Delete</button>
        </li>
    }
</ul>

@code {
    private string? newTaskDescription;
    private List<TaskItem> tasks = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("OnInitializedAsync called");
        tasks = await DbContext.Tasks.ToListAsync();
        Console.WriteLine($"Loaded {tasks.Count} tasks");
    }

    private async Task AddTask()
    {
        Console.WriteLine("AddTask called");
        if (!string.IsNullOrWhiteSpace(newTaskDescription))
        {
            Console.WriteLine($"Adding task: {newTaskDescription}");
            var newTask = new TaskItem { Description = newTaskDescription };
            DbContext.Tasks.Add(newTask);
            await DbContext.SaveChangesAsync();

            tasks.Add(newTask);
            newTaskDescription = string.Empty;
            StateHasChanged(); // Ensure the component state is updated
        }
        else
        {
            Console.WriteLine("newTaskDescription is null or whitespace");
        }
    }

    private async Task RemoveTask(TaskItem task)
    {
        DbContext.Tasks.Remove(task);
        await DbContext.SaveChangesAsync();

        tasks.Remove(task);
        StateHasChanged(); // Ensure the component state is updated
    }

    private async Task UpdateTask(TaskItem task)
    {
        DbContext.Tasks.Update(task);
        await DbContext.SaveChangesAsync();
        StateHasChanged(); // Ensure the component state is updated
    }
}